# =============================================================================
# GitHub Actions: Test Pipeline
# =============================================================================
# Runs on every push to main and on all PRs
# Executes pytest with coverage, linting, and Docker build validation
# Target: 170+ test cases, < 5 min execution time
# =============================================================================

name: Test Suite

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ---------------------------------------------------------------------------
  # Job: Python Tests with Coverage
  # ---------------------------------------------------------------------------
  test-python:
    name: "ðŸ§ª Python Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          pip install -e .
          pip install -r requirements-dev.txt

      - name: ðŸ§ª Run pytest with coverage
        run: |
          pytest tests/ \
            --cov=app \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=60 \
            -v \
            --tb=short \
            --durations=10 \
            -x

      - name: ðŸ“Š Coverage Report Summary
        if: always()
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage.xml ]; then
            python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          line_rate = float(root.attrib.get('line-rate', 0)) * 100
          print(f'| Metric | Value |')
          print(f'|--------|-------|')
          print(f'| Line Coverage | {line_rate:.1f}% |')
            " >> $GITHUB_STEP_SUMMARY
          fi

      - name: ï¿½ Test Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Tests completed successfully" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Job: Linting and Code Quality
  # ---------------------------------------------------------------------------
  lint:
    name: "ðŸ” Lint & Format"
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: ðŸ” Run Ruff linter
        run: |
          ruff check app/ tests/ --output-format=github

      - name: ðŸŽ¨ Check Ruff formatting
        run: |
          ruff format app/ tests/ --check --diff

      - name: ðŸ”¬ Run MyPy type checker
        run: |
          mypy app/ --ignore-missing-imports --no-error-summary
        continue-on-error: true

  # ---------------------------------------------------------------------------
  # Job: Docker Build Test
  # ---------------------------------------------------------------------------
  test-docker:
    name: "ðŸ³ Docker Build"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: email-service:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: ðŸ” Test Docker image
        run: |
          # Verify image was built
          docker images email-service:test
          
          # Test that container starts
          docker run --rm -d --name test-container \
            -e DATABASE_URL="postgresql+asyncpg://test:test@localhost/test" \
            -e SECRET_KEY="test-key" \
            email-service:test || true
          
          # Give it a moment
          sleep 2
          
          # Check if it's running (may fail without DB, that's ok)
          docker ps -a | grep test-container || true
          
          # Cleanup
          docker stop test-container 2>/dev/null || true
          
          echo "âœ… Docker image builds successfully"

      - name: ðŸ“ Check image size
        run: |
          SIZE=$(docker images email-service:test --format "{{.Size}}")
          echo "Docker image size: $SIZE"
          echo "## Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image Size | $SIZE |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Job: Security Scan (runs in parallel)
  # ---------------------------------------------------------------------------
  security:
    name: "ðŸ”’ Security Scan"
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install security tools
        run: |
          pip install bandit safety pip-audit

      - name: ðŸ”’ Run Bandit security linter
        run: |
          bandit -r app/ -ll -ii -x tests/ -f json -o bandit-report.json || true
          bandit -r app/ -ll -ii -x tests/ || true

      - name: ðŸ” Check dependencies for vulnerabilities
        run: |
          pip-audit -r requirements.txt || true
        continue-on-error: true

  # ---------------------------------------------------------------------------
  # Job: All Checks Pass Gate
  # ---------------------------------------------------------------------------
  all-checks:
    name: "âœ… All Checks"
    runs-on: ubuntu-latest
    needs: [test-python, lint, test-docker, security]
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.test-python.result }}" != "success" ]; then
            echo "âŒ Python tests failed"
            exit 1
          fi
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "âŒ Linting failed"
            exit 1
          fi
          if [ "${{ needs.test-docker.result }}" != "success" ]; then
            echo "âŒ Docker build failed"
            exit 1
          fi
          echo "âœ… All required checks passed!"

      - name: Summary
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ${{ needs.test-python.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Format | ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.test-docker.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
