# üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢: 8 –ö–æ–º–∞–Ω–¥ –¥–ª—è GitHub Copilot

> **–î–ª—è:** VS Code + GitHub Copilot  
> **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 2-3 —á–∞—Å–∞  
> **–†–µ–∑—É–ª—å—Ç–∞—Ç:** 1,700+ —Å—Ç—Ä–æ–∫ production-ready –∫–æ–¥–∞  
> **–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 15 –¥–µ–∫–∞–±—Ä—è 2025 –≥.

---

## üìã –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π—Ç–µ Copilot Chat
- Windows/Linux: `Ctrl+Alt+I`
- macOS: `Cmd+Opt+I`
- –ò–ª–∏: `Ctrl+Shift+P` ‚Üí "GitHub Copilot: Open Copilot Chat"

### –®–∞–≥ 2: –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É
- –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–∑ 8 –∫–æ–º–∞–Ω–¥ –Ω–∏–∂–µ
- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å —Ç–µ–∫—Å—Ç (–≤–∫–ª—é—á–∞—è –ø—Ä–∏–º–µ—Ä—ã –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)

### –®–∞–≥ 3: –í—Å—Ç–∞–≤—å—Ç–µ –≤ Copilot Chat
- –í—Å—Ç–∞–≤—å—Ç–µ: `Ctrl+V` (–∏–ª–∏ `Cmd+V`)
- –ù–∞–∂–º–∏—Ç–µ Enter

### –®–∞–≥ 4: –ü—Ä–∏–º–µ–Ω–∏—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥
- –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "Apply in Editor"
- –ò–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é –≤ —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª

### –®–∞–≥ 5: –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ 8 –∫–æ–º–∞–Ω–¥ –ø–æ –ø–æ—Ä—è–¥–∫—É

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢

- [ ] –ö–û–ú–ê–ù–î–ê 1: PostgreSQL Schema (15 –º–∏–Ω, ~350 —Å—Ç—Ä–æ–∫ SQL)
- [ ] –ö–û–ú–ê–ù–î–ê 2: Pydantic Models (15 –º–∏–Ω, ~200 —Å—Ç—Ä–æ–∫ Python)
- [ ] –ö–û–ú–ê–ù–î–ê 3: Email Parser (30 –º–∏–Ω, ~250 —Å—Ç—Ä–æ–∫ Python)
- [ ] –ö–û–ú–ê–ù–î–ê 4: Database Service (20 –º–∏–Ω, ~200 —Å—Ç—Ä–æ–∫ Python)
- [ ] –ö–û–ú–ê–ù–î–ê 5: FastAPI Application (30 –º–∏–Ω, ~200 —Å—Ç—Ä–æ–∫ Python)
- [ ] –ö–û–ú–ê–ù–î–ê 6: Unit + Integration Tests (30 –º–∏–Ω, ~200 —Å—Ç—Ä–æ–∫ Python)
- [ ] –ö–û–ú–ê–ù–î–ê 7: Docker Files (20 –º–∏–Ω, ~190 —Å—Ç—Ä–æ–∫ YAML/Dockerfile)
- [ ] –ö–û–ú–ê–ù–î–ê 8: Requirements + Documentation (10 –º–∏–Ω, ~145 —Å—Ç—Ä–æ–∫)

**–ò–¢–û–ì–û:** ~2-3 —á–∞—Å–∞, 1,735 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

---

# –ö–û–ú–ê–ù–î–ê 1: –°–æ–∑–¥–∞—Ç—å PostgreSQL Schema

## üìÑ –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –≤ Copilot Chat:

```
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `migrations/001_init_schema.sql` —Å PostgreSQL schema –¥–ª—è Email Intelligence Platform.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

1. **–¢–∞–±–ª–∏—Ü–∞ `emails`** (–æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–∏—Å–µ–º):
   - `id` UUID PRIMARY KEY
   - `message_id` VARCHAR(255) UNIQUE (IMAP Message-ID)
   - `imap_uid` BIGINT, `imap_folder` VARCHAR(100)
   - Headers: `from_address`, `from_name`, `to_addresses TEXT[]`, `cc_addresses TEXT[]`, `bcc_addresses TEXT[]`, `reply_to`, `subject`, `body_text`, `body_html`
   - Threading: `thread_id UUID REFERENCES threads`, `in_reply_to`, `references TEXT[]`
   - Classification: `intent` (invoice/order/complaint/inquiry/newsletter/spam/other), `sentiment` (positive/neutral/negative), `priority` (low/normal/high/urgent), `confidence_score NUMERIC(3,2)`
   - ERP: `erp_entity_type`, `erp_entity_id`, `erp_action_status` (pending/processing/completed/failed), `erp_action_result JSONB`
   - Metadata: `size_bytes`, `has_attachments BOOLEAN`, `attachment_count`, `flags TEXT[]`
   - Timestamps: `received_at`, `sent_at`, `parsed_at`, `classified_at`, `created_at`, `updated_at`

2. **–¢–∞–±–ª–∏—Ü–∞ `attachments`**:
   - `id` UUID PRIMARY KEY
   - `email_id UUID REFERENCES emails ON DELETE CASCADE`
   - File info: `filename`, `content_type`, `size_bytes`, `md5_hash`
   - S3 storage: `s3_bucket`, `s3_key`, `s3_url`
   - Metadata: `is_inline BOOLEAN`, `content_id` (for inline images)
   - Virus scan: `virus_scan_status` (pending/clean/infected/failed), `virus_scan_result JSONB`
   - Timestamps: `created_at`, `updated_at`

3. **–¢–∞–±–ª–∏—Ü–∞ `contacts`**:
   - `id` UUID PRIMARY KEY
   - `email VARCHAR(255) UNIQUE`, `name`
   - Statistics: `emails_sent_count`, `emails_received_count`, `last_email_at`
   - Classification: `is_customer`, `is_supplier`, `is_internal` (–≤—Å–µ BOOLEAN)
   - ERP: `erp_customer_id`, `erp_supplier_id`
   - Timestamps: `created_at`, `updated_at`

4. **–¢–∞–±–ª–∏—Ü–∞ `threads`**:
   - `id` UUID PRIMARY KEY
   - `subject TEXT`, `participant_emails TEXT[]`
   - Statistics: `email_count`, `last_email_at`
   - `intent`, `status` (active/resolved/archived)
   - Timestamps: `created_at`, `updated_at`

5. **–¢–∞–±–ª–∏—Ü–∞ `classification_history`** (audit trail –¥–ª—è LLM):
   - `id` UUID PRIMARY KEY
   - `email_id UUID REFERENCES emails ON DELETE CASCADE`
   - Result: `intent`, `sentiment`, `priority`, `confidence_score`
   - LLM details: `llm_model`, `llm_prompt TEXT`, `llm_response TEXT`, `llm_latency_ms`
   - `classified_at TIMESTAMP WITH TIME ZONE`

6. **–¢–∞–±–ª–∏—Ü–∞ `erp_actions`**:
   - `id` UUID PRIMARY KEY
   - `email_id UUID REFERENCES emails ON DELETE CASCADE`
   - Action: `action_type` (create_order/update_invoice/etc.), `entity_type`, `entity_id`
   - Request/Response: `request_payload JSONB`, `response_payload JSONB`
   - Status: `status` (pending/success/failed/retrying), `error_message`, `retry_count`
   - Timestamps: `executed_at`, `completed_at`

7. **–¢–∞–±–ª–∏—Ü–∞ `processing_queue`**:
   - `id` UUID PRIMARY KEY
   - `email_id UUID REFERENCES emails ON DELETE CASCADE`
   - Queue: `queue_name` (parsing/classification/erp_action), `priority INTEGER` (1-10)
   - Processing: `status` (pending/processing/completed/failed), `attempts`, `max_attempts`, `last_error`
   - Timestamps: `created_at`, `scheduled_at`, `started_at`, `completed_at`

8. **–¢–∞–±–ª–∏—Ü–∞ `api_metrics`**:
   - `id` UUID PRIMARY KEY
   - Request: `endpoint`, `method`, `status_code`, `latency_ms`
   - User: `client_ip`, `user_agent`
   - `created_at TIMESTAMP WITH TIME ZONE`

**–ò–Ω–¥–µ–∫—Å—ã (–º–∏–Ω–∏–º—É–º 15):**
- `idx_emails_message_id ON emails(message_id)`
- `idx_emails_from_address ON emails(from_address)`
- `idx_emails_thread_id ON emails(thread_id)`
- `idx_emails_received_at ON emails(received_at DESC)`
- `idx_emails_intent ON emails(intent) WHERE intent IS NOT NULL`
- `idx_emails_erp_status ON emails(erp_action_status)`
- `idx_emails_has_attachments ON emails(has_attachments) WHERE has_attachments = TRUE`
- `idx_emails_subject_fts ON emails USING gin(to_tsvector('russian', subject))`
- `idx_emails_body_fts ON emails USING gin(to_tsvector('russian', body_text))`
- `idx_attachments_email_id ON attachments(email_id)`
- `idx_attachments_md5_hash ON attachments(md5_hash)`
- `idx_contacts_email ON contacts(email)`
- `idx_threads_last_email_at ON threads(last_email_at DESC)`
- `idx_queue_status_priority ON processing_queue(status, priority DESC, scheduled_at ASC)`
- `idx_metrics_endpoint ON api_metrics(endpoint)`

**Triggers:**
- `trg_emails_updated_at` - Auto-update `updated_at` –Ω–∞ UPDATE –¥–ª—è `emails`
- `trg_attachments_updated_at` - Auto-update –¥–ª—è `attachments`
- `trg_contacts_updated_at` - Auto-update –¥–ª—è `contacts`
- `trg_threads_updated_at` - Auto-update –¥–ª—è `threads`

**Views (3 —à—Ç—É–∫–∏):**
1. `email_stats_by_sender` - GROUP BY from_address —Å COUNT, AVG(size_bytes), MAX(received_at), ARRAY_AGG(intent)
2. `email_volume_daily` - GROUP BY DATE(received_at) —Å COUNT –ø–æ –∫–∞–∂–¥–æ–º—É intent
3. `erp_action_stats` - GROUP BY action_type —Å success_rate_pct –∏ avg_duration_sec

**Function:**
- `update_updated_at_column()` - –¥–ª—è trigger updated_at (RETURNS TRIGGER, NEW.updated_at = NOW())
- `cleanup_old_queue_items()` - DELETE FROM processing_queue WHERE status IN ('completed', 'failed') AND completed_at < NOW() - INTERVAL '7 days'

**–í–ê–ñ–ù–û:**
- –ò—Å–ø–æ–ª—å–∑—É–π PostgreSQL 15+ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
- –í—Å–µ PRIMARY KEY –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å UUID —Å DEFAULT gen_random_uuid()
- –í—Å–µ TIMESTAMP –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å WITH TIME ZONE
- –í—Å–µ TEXT[] –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å DEFAULT '{}'
- –î–æ–±–∞–≤—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Å–ª–æ–∂–Ω—ã–º –∏–Ω–¥–µ–∫—Å–∞–º

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä:** ~350-400 —Å—Ç—Ä–æ–∫ SQL

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ–ª–Ω—ã–π SQL —Ñ–∞–π–ª —Å:
1. CREATE TABLE –¥–ª—è –≤—Å–µ—Ö 8 —Ç–∞–±–ª–∏—Ü
2. CREATE INDEX –¥–ª—è –≤—Å–µ—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
3. CREATE TRIGGER –¥–ª—è –≤—Å–µ—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
4. CREATE VIEW –¥–ª—è –≤—Å–µ—Ö views
5. CREATE FUNCTION –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
```

---

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª `migrations/001_init_schema.sql` —Å–æ–¥–µ—Ä–∂–∏—Ç:
- ‚úÖ 8 —Ç–∞–±–ª–∏—Ü (emails, attachments, contacts, threads, classification_history, erp_actions, processing_queue, api_metrics)
- ‚úÖ 15+ –∏–Ω–¥–µ–∫—Å–æ–≤
- ‚úÖ 4 —Ç—Ä–∏–≥–≥–µ—Ä–∞
- ‚úÖ 3 views
- ‚úÖ 2 —Ñ—É–Ω–∫—Ü–∏–∏

---

# –ö–û–ú–ê–ù–î–ê 2: –°–æ–∑–¥–∞—Ç—å Pydantic Models

## üìÑ –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –≤ Copilot Chat:

```
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `app/models/email_models.py` —Å Pydantic models –¥–ª—è Email Intelligence Platform.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

1. **Enums (6 —à—Ç—É–∫):**
   - `EmailIntent(str, Enum)`: INVOICE, ORDER, COMPLAINT, INQUIRY, NEWSLETTER, SPAM, OTHER
   - `EmailSentiment(str, Enum)`: POSITIVE, NEUTRAL, NEGATIVE
   - `EmailPriority(str, Enum)`: LOW, NORMAL, HIGH, URGENT
   - `ERPActionStatus(str, Enum)`: PENDING, PROCESSING, COMPLETED, FAILED
   - `VirusScanStatus(str, Enum)`: PENDING, CLEAN, INFECTED, FAILED
   - `ThreadStatus(str, Enum)`: ACTIVE, RESOLVED, ARCHIVED

2. **Base Models:**

   **AttachmentBase:**
   - `filename: str` (Field max_length=255)
   - `content_type: Optional[str]` (max_length=100)
   - `size_bytes: int` (Field ge=0)
   - `md5_hash: Optional[str]` (max_length=32)
   - `is_inline: bool = False`
   - `content_id: Optional[str]`

   **AttachmentCreate (extends AttachmentBase):**
   - `email_id: UUID`
   - `s3_bucket: Optional[str]`
   - `s3_key: Optional[str]`

   **AttachmentDB (extends AttachmentBase):**
   - `id: UUID`
   - `email_id: UUID`
   - `s3_bucket: Optional[str]`
   - `s3_key: Optional[str]`
   - `s3_url: Optional[str]`
   - `virus_scan_status: VirusScanStatus`
   - `virus_scan_result: Optional[dict]`
   - `created_at: datetime`
   - `updated_at: datetime`
   - `Config: from_attributes = True`

   **EmailBase:**
   - `message_id: str` (max_length=255)
   - `from_address: EmailStr`
   - `from_name: Optional[str]` (max_length=255)
   - `to_addresses: List[EmailStr]` (min_items=1)
   - `cc_addresses: Optional[List[EmailStr]] = []`
   - `bcc_addresses: Optional[List[EmailStr]] = []`
   - `reply_to: Optional[EmailStr]`
   - `subject: Optional[str]`
   - `body_text: Optional[str]`
   - `body_html: Optional[str]`
   - `received_at: datetime`
   - `sent_at: Optional[datetime]`
   - **Validator** `validate_email_lists` –¥–ª—è to_addresses/cc_addresses/bcc_addresses - —É–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑ set()

   **EmailCreate (extends EmailBase):**
   - `imap_uid: Optional[int]`
   - `imap_folder: str = "INBOX"`
   - `in_reply_to: Optional[str]`
   - `references: Optional[List[str]] = []`
   - `size_bytes: Optional[int]`
   - `flags: Optional[List[str]] = []`

   **EmailDB (extends EmailBase):**
   - `id: UUID`
   - `imap_uid: Optional[int]`
   - `imap_folder: str`
   - `thread_id: Optional[UUID]`
   - `in_reply_to: Optional[str]`
   - `references: Optional[List[str]]`
   - `intent: Optional[EmailIntent]`
   - `sentiment: Optional[EmailSentiment]`
   - `priority: EmailPriority`
   - `confidence_score: Optional[float]` (ge=0.0, le=1.0)
   - `erp_entity_type: Optional[str]`
   - `erp_entity_id: Optional[str]`
   - `erp_action_status: ERPActionStatus`
   - `erp_action_result: Optional[dict]`
   - `size_bytes: Optional[int]`
   - `has_attachments: bool`
   - `attachment_count: int`
   - `flags: Optional[List[str]]`
   - `parsed_at: datetime`
   - `classified_at: Optional[datetime]`
   - `created_at: datetime`
   - `updated_at: datetime`
   - `Config: from_attributes = True`

   **EmailWithAttachments (extends EmailDB):**
   - `attachments: List[AttachmentDB] = []`

3. **Classification Models:**

   **ClassificationRequest:**
   - `email_id: UUID`
   - `subject: str`
   - `body_text: str`
   - `from_address: EmailStr`

   **ClassificationResult:**
   - `intent: EmailIntent`
   - `sentiment: EmailSentiment`
   - `priority: EmailPriority`
   - `confidence_score: float` (ge=0.0, le=1.0)
   - `reasoning: Optional[str]` (explanation from LLM)

4. **API Request/Response Models:**

   **ParseEmailRequest:**
   - `raw_email: bytes` (description="Raw email in RFC822 format")
   - `imap_uid: Optional[int]`
   - `imap_folder: str = "INBOX"`

   **ParseEmailResponse:**
   - `email: EmailWithAttachments`
   - `processing_time_ms: int`

   **HealthCheckResponse:**
   - `status: str`
   - `database: str`
   - `redis: Optional[str]`
   - `kafka: Optional[str]`
   - `timestamp: datetime`

   **MetricsResponse:**
   - `total_emails: int`
   - `emails_last_24h: int`
   - `emails_pending_classification: int`
   - `emails_pending_erp_action: int`
   - `avg_classification_time_ms: float`
   - `avg_parse_time_ms: float`

**Imports:**
```python
from datetime import datetime
from typing import List, Optional
from uuid import UUID
from pydantic import BaseModel, EmailStr, Field, validator
from enum import Enum
```

**–í–ê–ñ–ù–û:**
- –í—Å–µ –º–æ–¥–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å docstrings
- –ò—Å–ø–æ–ª—å–∑—É–π type hints –≤–µ–∑–¥–µ
- Validators –¥–æ–ª–∂–Ω—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- Config class –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π DB –º–æ–¥–µ–ª–∏

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä:** ~200-250 —Å—Ç—Ä–æ–∫ Python

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ–ª–Ω—ã–π Python —Ñ–∞–π–ª —Å:
1. –í—Å–µ–º–∏ Enums (6 —à—Ç—É–∫)
2. –í—Å–µ–º–∏ Base/Create/DB –º–æ–¥–µ–ª—è–º–∏ –¥–ª—è Attachment –∏ Email
3. Classification –º–æ–¥–µ–ª—è–º–∏
4. API Request/Response –º–æ–¥–µ–ª—è–º–∏
5. Validators –≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
```

---

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª `app/models/email_models.py` —Å–æ–¥–µ—Ä–∂–∏—Ç:
- ‚úÖ 6 Enums
- ‚úÖ 10+ Pydantic models
- ‚úÖ Validators –¥–ª—è email lists
- ‚úÖ Type hints –≤–µ–∑–¥–µ

---

# –ö–û–ú–ê–ù–î–ê 3: –°–æ–∑–¥–∞—Ç—å Email Parser Service

## üìÑ –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –≤ Copilot Chat:

```
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `app/services/email_parser.py` —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º email parser –¥–ª—è Email Intelligence Platform.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

1. **–ö–ª–∞—Å—Å `EmailParserService`:**
   - `__init__(self, s3_bucket: str, s3_client: Optional[boto3.client] = None)`
   - –°–æ–∑–¥–∞—ë—Ç S3 client –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω

2. **–ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ `async def parse_email(self, raw_email: bytes) -> EmailWithAttachments`:**
   - –ü–∞—Ä—Å–∏—Ç raw email —á–µ—Ä–µ–∑ `email.message_from_bytes(raw_email, policy=policy.default)`
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç headers —á–µ—Ä–µ–∑ `_parse_headers(msg)`
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç body —á–µ—Ä–µ–∑ `_parse_body(msg)` ‚Üí returns (body_text, body_html)
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç attachments —á–µ—Ä–µ–∑ `_parse_attachments(msg)` ‚Üí returns List[dict]
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç attachments –≤ S3 —á–µ—Ä–µ–∑ `_upload_to_s3()`
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `EmailWithAttachments` object
   - –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
   - **Exception handling:** –ü—Ä–∏ –æ—à–∏–±–∫–µ –ª–æ–≥–∏—Ä—É–µ—Ç `exc_info=True` –∏ re-raise

3. **–ú–µ—Ç–æ–¥ `_parse_headers(self, msg: EmailMessage) -> dict`:**
   - Message-ID: `msg.get('Message-ID', str(uuid4()))`
   - From: –ø–∞—Ä—Å–∏—Ç "Name <email@example.com>" ‚Üí `from_name` –∏ `from_address`
   - To, CC, BCC: —á–µ—Ä–µ–∑ `_parse_address_list()`
   - Reply-To: –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
   - Subject: `msg.get('Subject')`
   - Date: —á–µ—Ä–µ–∑ `email.utils.parsedate_to_datetime()` ‚Üí `sent_at`
   - received_at: `datetime.utcnow()`
   - Threading: `In-Reply-To`, `References` (split by space)
   - Returns dict —Å –≤—Å–µ–º–∏ headers

4. **–ú–µ—Ç–æ–¥ `_parse_address_list(self, address_str: str) -> List[str]`:**
   - Split by comma
   - –ï—Å–ª–∏ "<>" present ‚Üí extract email between <>
   - Returns list of email addresses

5. **–ú–µ—Ç–æ–¥ `_parse_body(self, msg: EmailMessage) -> Tuple[Optional[str], Optional[str]]`:**
   - –ï—Å–ª–∏ multipart ‚Üí walk through parts
   - –ò—â–µ—Ç `content_type == 'text/plain'` ‚Üí `body_text`
   - –ò—â–µ—Ç `content_type == 'text/html'` ‚Üí `body_html`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `part.get_content()` –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
   - **Exception handling:** try/except –¥–ª—è UnicodeDecodeError
   - Returns (body_text, body_html)

6. **–ú–µ—Ç–æ–¥ `_parse_attachments(self, msg: EmailMessage) -> List[dict]`:**
   - Skip –µ—Å–ª–∏ non-multipart
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ part:
     - Skip –µ—Å–ª–∏ text/plain –∏–ª–∏ text/html
     - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `Content-Disposition` in ('attachment', 'inline')
     - –ò–∑–≤–ª–µ–∫–∞–µ—Ç filename –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `attachment_{uuid}.{ext}`
     - –ü–æ–ª—É—á–∞–µ—Ç content —á–µ—Ä–µ–∑ `part.get_content()`
     - –ï—Å–ª–∏ content is str ‚Üí encode to bytes
     - –°–æ–±–∏—Ä–∞–µ—Ç dict: `{'filename', 'content', 'content_type', 'is_inline', 'content_id'}`
   - **Exception handling:** try/except per attachment
   - Returns List[dict]

7. **–ú–µ—Ç–æ–¥ `async def _upload_to_s3(self, content: bytes, filename: str, content_type: str) -> str`:**
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç S3 key: `emails/{year}/{month}/{day}/{uuid}/{filename}`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `datetime.utcnow()` –¥–ª—è path
   - –í—ã–∑—ã–≤–∞–µ—Ç `s3_client.put_object(Bucket=..., Key=..., Body=..., ContentType=...)`
   - **Exception handling:** ClientError ‚Üí logger.error + re-raise
   - Returns s3_key

**Imports:**
```python
import email
import hashlib
import logging
from email import policy
from email.message import EmailMessage
from datetime import datetime
from typing import List, Optional, Tuple
from uuid import uuid4
import boto3
from botocore.exceptions import ClientError

from app.models.email_models import (
    EmailCreate,
    AttachmentCreate,
    EmailWithAttachments,
)
```

**Logging:**
- `logger = logging.getLogger(__name__)`
- –ò—Å–ø–æ–ª—å–∑—É–π `logger.info()` –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–π `logger.error(..., exc_info=True)` –¥–ª—è –æ—à–∏–±–æ–∫
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
  - –ü–æ—Å–ª–µ parse_email: `f"Parsed email {message_id} in {parse_time_ms}ms ({len(attachments)} attachments)"`
  - –ü–æ—Å–ª–µ upload_to_s3: `f"Uploaded {filename} to s3://{bucket}/{key}"`
  - –ü—Ä–∏ –æ—à–∏–±–∫–µ: `f"Failed to parse email: {e}"`

**–í–ê–ñ–ù–û:**
- –í—Å–µ –º–µ—Ç–æ–¥—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å docstrings –≤ Google Style
- Type hints –≤–µ–∑–¥–µ
- Exception handling –≤ –∫–∞–∂–¥–æ–º –º–µ—Ç–æ–¥–µ
- MD5 hash –¥–ª—è attachments: `hashlib.md5(content).hexdigest()`

**–ü—Ä–∏–º–µ—Ä –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
```python
raw_email = b"""From: John Doe <john@example.com>
To: jane@example.com
Subject: Test Email
Content-Type: text/plain; charset=utf-8

Hello World
"""
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
EmailWithAttachments(
    message_id="...",
    from_address="john@example.com",
    from_name="John Doe",
    to_addresses=["jane@example.com"],
    subject="Test Email",
    body_text="Hello World",
    attachments=[],
    ...
)
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä:** ~250-300 —Å—Ç—Ä–æ–∫ Python

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ–ª–Ω—ã–π Python —Ñ–∞–π–ª —Å:
1. –ö–ª–∞—Å—Å EmailParserService
2. –í—Å–µ 7 –º–µ—Ç–æ–¥–æ–≤ —Å docstrings
3. Exception handling
4. Logging
5. Type hints
```

---

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª `app/services/email_parser.py` —Å–æ–¥–µ—Ä–∂–∏—Ç:
- ‚úÖ –ö–ª–∞—Å—Å EmailParserService
- ‚úÖ 7 –º–µ—Ç–æ–¥–æ–≤ (parse_email, _parse_headers, _parse_address_list, _parse_body, _parse_attachments, _upload_to_s3, __init__)
- ‚úÖ Exception handling –≤ –∫–∞–∂–¥–æ–º –º–µ—Ç–æ–¥–µ
- ‚úÖ Logging

---

# –ö–û–ú–ê–ù–î–ê 4: –°–æ–∑–¥–∞—Ç—å Database Service

## üìÑ –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –≤ Copilot Chat:

```
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `app/services/database.py` —Å async database service –¥–ª—è Email Intelligence Platform –∏—Å–ø–æ–ª—å–∑—É—è SQLAlchemy 2.0.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

1. **–ö–ª–∞—Å—Å `DatabaseService`:**
   - `__init__(self, session: AsyncSession)`
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç session –∫–∞–∫ `self.session`

2. **–ú–µ—Ç–æ–¥ `async def create_email(self, email_data: EmailCreate, attachments: Optional[List[AttachmentCreate]] = None) -> EmailWithAttachments`:**
   - –°–æ–∑–¥–∞—ë—Ç Email record: `email = Email(**email_data.dict())`
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `email.has_attachments = bool(attachments)`
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `email.attachment_count = len(attachments) if attachments else 0`
   - –î–æ–±–∞–≤–ª—è–µ—Ç –≤ session: `self.session.add(email)`
   - –î–µ–ª–∞–µ—Ç flush –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è email.id: `await self.session.flush()`
   - –°–æ–∑–¥–∞—ë—Ç Attachment records –≤ —Ü–∏–∫–ª–µ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è `email_id=email.id`
   - –í—ã–∑—ã–≤–∞–µ—Ç `await self._update_contact(email_data.from_address, email_data.from_name)`
   - –î–µ–ª–∞–µ—Ç commit: `await self.session.commit()`
   - –î–µ–ª–∞–µ—Ç refresh: `await self.session.refresh(email)`
   - –õ–æ–≥–∏—Ä—É–µ—Ç: `f"Created email {email.id} with {len(attachments)} attachments"`
   - **Exception handling:** –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Üí `await self.session.rollback()` + logger.error + re-raise
   - Returns `EmailWithAttachments`

3. **–ú–µ—Ç–æ–¥ `async def get_email(self, email_id: UUID) -> Optional[EmailWithAttachments]`:**
   - –°–æ–∑–¥–∞—ë—Ç statement: `stmt = select(Email).options(selectinload(Email.attachments)).where(Email.id == email_id)`
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç: `result = await self.session.execute(stmt)`
   - –ü–æ–ª—É—á–∞–µ—Ç: `email = result.scalar_one_or_none()`
   - –ï—Å–ª–∏ None ‚Üí return None
   - –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ EmailWithAttachments —á–µ—Ä–µ–∑ `EmailDB.from_orm(email)`
   - Returns EmailWithAttachments

4. **–ú–µ—Ç–æ–¥ `async def update_classification(self, email_id: UUID, classification: ClassificationResult) -> EmailDB`:**
   - –ü–æ–ª—É—á–∞–µ—Ç email: `stmt = select(Email).where(Email.id == email_id)`
   - –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí raise `ValueError(f"Email {email_id} not found")`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—è:
     - `email.intent = classification.intent`
     - `email.sentiment = classification.sentiment`
     - `email.priority = classification.priority`
     - `email.confidence_score = classification.confidence_score`
     - `email.classified_at = datetime.utcnow()`
   - –°–æ–∑–¥–∞—ë—Ç ClassificationHistory record:
     - `history = ClassificationHistory(email_id=email_id, intent=..., llm_model="llama-3.1-8b", llm_response=classification.reasoning, ...)`
     - `self.session.add(history)`
   - –î–µ–ª–∞–µ—Ç commit –∏ refresh
   - –õ–æ–≥–∏—Ä—É–µ—Ç: `f"Updated classification for email {email_id}: {classification.intent}"`
   - **Exception handling:** rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ
   - Returns `EmailDB.from_orm(email)`

5. **–ú–µ—Ç–æ–¥ `async def get_emails_pending_classification(self, limit: int = 100) -> List[EmailDB]`:**
   - Statement: `select(Email).where(and_(Email.intent.is_(None), Email.classified_at.is_(None))).order_by(Email.received_at.desc()).limit(limit)`
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ `EmailDB`

6. **–ú–µ—Ç–æ–¥ `async def get_emails_last_24h(self) -> int`:**
   - –°—á–∏—Ç–∞–µ—Ç emails –≥–¥–µ `received_at >= datetime.utcnow() - timedelta(hours=24)`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `func.count(Email.id)`
   - Returns int

7. **–ú–µ—Ç–æ–¥ `async def get_total_emails(self) -> int`:**
   - –°—á–∏—Ç–∞–µ—Ç –≤—Å–µ emails: `func.count(Email.id)`
   - Returns int

8. **–ú–µ—Ç–æ–¥ `async def _update_contact(self, email: str, name: Optional[str] = None)`:**
   - –ò—â–µ—Ç Contact: `select(Contact).where(Contact.email == email)`
   - –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω:
     - `contact.emails_received_count += 1`
     - `contact.last_email_at = datetime.utcnow()`
     - `if name and not contact.name: contact.name = name`
   - –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π:
     - `contact = Contact(email=email, name=name, emails_received_count=1, last_email_at=datetime.utcnow())`
     - `self.session.add(contact)`
   - –î–µ–ª–∞–µ—Ç flush (–ë–ï–ó commit - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
   - **Exception handling:** try/except ‚Üí logger.error (–Ω–µ re-raise)

9. **–ú–µ—Ç–æ–¥ `async def create_erp_action(self, email_id: UUID, action_type: str, entity_type: str, entity_id: str, request_payload: dict) -> UUID`:**
   - –°–æ–∑–¥–∞—ë—Ç ERPAction: `action = ERPAction(..., status="pending")`
   - –î–æ–±–∞–≤–ª—è–µ—Ç, commit, refresh
   - –õ–æ–≥–∏—Ä—É–µ—Ç: `f"Created ERP action {action.id} for email {email_id}"`
   - Returns `action.id`

10. **–ú–µ—Ç–æ–¥ `async def update_erp_action(self, action_id: UUID, status: ERPActionStatus, response_payload: Optional[dict] = None, error_message: Optional[str] = None)`:**
    - –ù–∞—Ö–æ–¥–∏—Ç ERPAction –ø–æ ID
    - –û–±–Ω–æ–≤–ª—è–µ—Ç `status`, `response_payload`, `error_message`
    - –ï—Å–ª–∏ status in ("success", "failed") ‚Üí `action.completed_at = datetime.utcnow()`
    - Commit
    - –õ–æ–≥–∏—Ä—É–µ—Ç: `f"Updated ERP action {action_id} status: {status}"`

**Imports:**
```python
import logging
from typing import List, Optional
from uuid import UUID
from datetime import datetime, timedelta
from sqlalchemy import select, func, and_
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import selectinload

from app.models.email_models import (
    EmailCreate,
    EmailDB,
    EmailWithAttachments,
    AttachmentCreate,
    AttachmentDB,
    ClassificationResult,
    ERPActionStatus,
)
from app.db.models import (
    Email,
    Attachment,
    Contact,
    Thread,
    ClassificationHistory,
    ERPAction,
)
```

**–í–ê–ñ–ù–û:**
- –í—Å–µ –º–µ—Ç–æ–¥—ã async
- –ò—Å–ø–æ–ª—å–∑—É–π SQLAlchemy 2.0 —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (`select()` –≤–º–µ—Å—Ç–æ `query()`)
- –í—Å–µ DB –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ async session
- Exception handling —Å rollback
- Type hints –≤–µ–∑–¥–µ
- Docstrings –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä:** ~200-250 —Å—Ç—Ä–æ–∫ Python

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ–ª–Ω—ã–π Python —Ñ–∞–π–ª —Å:
1. –ö–ª–∞—Å—Å DatabaseService
2. –í—Å–µ 10+ –º–µ—Ç–æ–¥–æ–≤
3. Exception handling
4. Logging
5. Type hints
```

---

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª `app/services/database.py` —Å–æ–¥–µ—Ä–∂–∏—Ç:
- ‚úÖ –ö–ª–∞—Å—Å DatabaseService
- ‚úÖ 10+ async –º–µ—Ç–æ–¥–æ–≤
- ‚úÖ SQLAlchemy 2.0 —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
- ‚úÖ Exception handling —Å rollback

---

# –ö–û–ú–ê–ù–î–ê 5: –°–æ–∑–¥–∞—Ç—å FastAPI Application

## üìÑ –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –≤ Copilot Chat:

```
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `app/main.py` —Å FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –¥–ª—è Email Intelligence Platform.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

1. **FastAPI App Setup:**
   - `app = FastAPI(title="Email Intelligence Platform", version="1.0.0")`
   - CORS middleware: `app.add_middleware(CORSMiddleware, allow_origins=["*"], allow_methods=["*"], allow_headers=["*"])`
   - Prometheus middleware –¥–ª—è –º–µ—Ç—Ä–∏–∫

2. **Dependency Injection:**
   - `async def get_db_session() -> AsyncIterator[AsyncSession]`:
     - –°–æ–∑–¥–∞—ë—Ç async session
     - `async with async_session_maker() as session: yield session`
   - `async def get_database_service(session: AsyncSession = Depends(get_db_session)) -> DatabaseService`:
     - Returns `DatabaseService(session)`
   - `async def get_email_parser() -> EmailParserService`:
     - Returns `EmailParserService(s3_bucket=settings.S3_BUCKET)`

3. **Endpoint: `GET /health`:**
   - Returns `HealthCheckResponse`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç database connection:
     - `await session.execute(select(1))`
     - –ï—Å–ª–∏ success ‚Üí `database="connected"`
     - –ï—Å–ª–∏ fail ‚Üí `database="disconnected"`
   - Returns:
     ```python
     {
         "status": "healthy",
         "database": "connected",
         "timestamp": datetime.utcnow()
     }
     ```

4. **Endpoint: `GET /ready`:**
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `/health` –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 503 –µ—Å–ª–∏ database disconnected
   - Use case: Kubernetes readiness probe

5. **Endpoint: `POST /parse`:**
   - Request body: `ParseEmailRequest`
   - Dependency: `EmailParserService`, `DatabaseService`
   - –õ–æ–≥–∏–∫–∞:
     1. –ü–∞—Ä—Å–∏—Ç email: `email = await parser.parse_email(request.raw_email)`
     2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î: `email_db = await db.create_email(email, email.attachments)`
     3. –î–æ–±–∞–≤–ª—è–µ—Ç –≤ processing queue (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
     4. –°—á–∏—Ç–∞–µ—Ç `processing_time_ms`
   - Returns `ParseEmailResponse(email=email_db, processing_time_ms=...)`
   - **Exception handling:** HTTPException 400 –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞

6. **Endpoint: `POST /classify`:**
   - Request body: `ClassificationRequest`
   - Dependency: `DatabaseService`, LLM client (–Ω–∞–ø—Ä–∏–º–µ—Ä Ollama)
   - –õ–æ–≥–∏–∫–∞:
     1. –ü–æ–ª—É—á–∞–µ—Ç email –∏–∑ –ë–î
     2. –§–æ—Ä–º–∏—Ä—É–µ—Ç prompt –¥–ª—è LLM:
        ```
        Classify this email:
        From: {from_address}
        Subject: {subject}
        Body: {body_text}
        
        Return JSON: {"intent": "...", "sentiment": "...", "priority": "...", "confidence": 0.0-1.0, "reasoning": "..."}
        ```
     3. –í—ã–∑—ã–≤–∞–µ—Ç LLM
     4. –ü–∞—Ä—Å–∏—Ç JSON response
     5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç classification: `await db.update_classification(email_id, result)`
   - Returns `ClassificationResult`
   - **Exception handling:** HTTPException 500 –ø—Ä–∏ –æ—à–∏–±–∫–µ LLM

7. **Endpoint: `GET /metrics`:**
   - Dependency: `DatabaseService`
   - –õ–æ–≥–∏–∫–∞:
     1. –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
        - `total_emails = await db.get_total_emails()`
        - `emails_last_24h = await db.get_emails_last_24h()`
        - `emails_pending_classification = len(await db.get_emails_pending_classification())`
     2. –°—á–∏—Ç–∞–µ—Ç avg times –∏–∑ api_metrics —Ç–∞–±–ª–∏—Ü—ã
   - Returns `MetricsResponse`

8. **Background Task: Process Pending Classifications:**
   - –§—É–Ω–∫—Ü–∏—è `async def process_pending_classifications_task()`:
     - –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª `while True`:
       - –ü–æ–ª—É—á–∞–µ—Ç pending emails
       - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑—ã–≤–∞–µ—Ç `/classify` endpoint
       - `await asyncio.sleep(60)` –º–µ–∂–¥—É –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ startup: `@app.on_event("startup")`

**Imports:**
```python
from fastapi import FastAPI, Depends, HTTPException, status
from fastapi.middleware.cors import CORSMiddleware
from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine, async_sessionmaker
from sqlalchemy import select
from typing import AsyncIterator
import asyncio
import logging
from datetime import datetime

from app.models.email_models import (
    ParseEmailRequest,
    ParseEmailResponse,
    ClassificationRequest,
    ClassificationResult,
    HealthCheckResponse,
    MetricsResponse,
)
from app.services.email_parser import EmailParserService
from app.services.database import DatabaseService
```

**Settings (—á–µ—Ä–µ–∑ pydantic-settings):**
```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    DATABASE_URL: str = "postgresql+asyncpg://email_user:email_pass@localhost:5432/email_db"
    S3_BUCKET: str = "email-attachments"
    OLLAMA_URL: str = "http://localhost:11434"
    LOG_LEVEL: str = "INFO"
    
    class Config:
        env_file = ".env"

settings = Settings()
```

**Logging setup:**
```python
logging.basicConfig(
    level=settings.LOG_LEVEL,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)
```

**SQLAlchemy engine:**
```python
engine = create_async_engine(
    settings.DATABASE_URL,
    echo=False,
    pool_pre_ping=True,
    pool_size=10,
    max_overflow=20
)
async_session_maker = async_sessionmaker(engine, expire_on_commit=False)
```

**–í–ê–ñ–ù–û:**
- –í—Å–µ endpoints async
- Exception handling —Å HTTPException
- Logging –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- Type hints –≤–µ–∑–¥–µ
- Docstrings –¥–ª—è endpoints

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä:** ~200-250 —Å—Ç—Ä–æ–∫ Python

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ–ª–Ω—ã–π Python —Ñ–∞–π–ª —Å:
1. FastAPI app setup
2. Dependency injection
3. 6 endpoints (/health, /ready, /parse, /classify, /metrics)
4. Background task –¥–ª—è classification
5. Settings —á–µ—Ä–µ–∑ pydantic-settings
6. SQLAlchemy async engine
```

---

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª `app/main.py` —Å–æ–¥–µ—Ä–∂–∏—Ç:
- ‚úÖ FastAPI app —Å CORS
- ‚úÖ 6 endpoints
- ‚úÖ Dependency injection
- ‚úÖ Background task

---

# –ö–û–ú–ê–ù–î–ê 6: –°–æ–∑–¥–∞—Ç—å Unit + Integration Tests

## üìÑ –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –≤ Copilot Chat:

```
–°–æ–∑–¥–∞–π 2 —Ñ–∞–π–ª–∞ —Å —Ç–µ—Å—Ç–∞–º–∏ –¥–ª—è Email Intelligence Platform:

**–§–ê–ô–õ 1: `tests/test_email_parser.py`** (Unit tests –¥–ª—è EmailParserService)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

1. **Fixture `email_parser`:**
   - –°–æ–∑–¥–∞—ë—Ç EmailParserService —Å mock S3 client
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `pytest.fixture`

2. **Fixture `sample_raw_email`:**
   - Returns bytes —Å –ø—Ä–æ—Å—Ç—ã–º email:
     ```
     From: john@example.com
     To: jane@example.com
     Subject: Test
     Content-Type: text/plain
     
     Hello
     ```

3. **Test `test_parse_simple_email(email_parser, sample_raw_email)`:**
   - –ü–∞—Ä—Å–∏—Ç sample_raw_email
   - Assert: `result.from_address == "john@example.com"`
   - Assert: `result.to_addresses == ["jane@example.com"]`
   - Assert: `result.subject == "Test"`
   - Assert: `result.body_text == "Hello"`

4. **Test `test_parse_email_with_attachment(email_parser)`:**
   - –°–æ–∑–¥–∞—ë—Ç multipart email —Å 1 PDF attachment
   - –ü–∞—Ä—Å–∏—Ç
   - Assert: `result.has_attachments == True`
   - Assert: `len(result.attachments) == 1`
   - Assert: `result.attachments[0].filename == "test.pdf"`

5. **Test `test_parse_email_with_inline_image(email_parser)`:**
   - –°–æ–∑–¥–∞—ë—Ç multipart email —Å inline image (Content-ID: <img1>)
   - –ü–∞—Ä—Å–∏—Ç
   - Assert: `result.attachments[0].is_inline == True`
   - Assert: `result.attachments[0].content_id == "img1"`

6. **Test `test_parse_invalid_email(email_parser)`:**
   - –ü—ã—Ç–∞–µ—Ç—Å—è –ø–∞—Ä—Å–∏—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π bytes
   - Assert: raises Exception

**–§–ê–ô–õ 2: `tests/test_integration.py`** (Integration tests)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

1. **Fixture `test_db_session`:**
   - –°–æ–∑–¥–∞—ë—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é PostgreSQL –ë–î (—á–µ—Ä–µ–∑ testcontainers –∏–ª–∏ sqlite)
   - –ü—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç async session
   - –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ —É–¥–∞–ª—è–µ—Ç –ë–î

2. **Fixture `database_service(test_db_session)`:**
   - Returns `DatabaseService(test_db_session)`

3. **Test `test_create_and_retrieve_email(database_service)`:**
   - –°–æ–∑–¥–∞—ë—Ç email —á–µ—Ä–µ–∑ `database_service.create_email()`
   - –ü–æ–ª—É—á–∞–µ—Ç —á–µ—Ä–µ–∑ `database_service.get_email(email_id)`
   - Assert: email retrieved successfully
   - Assert: –≤—Å–µ –ø–æ–ª—è —Å–æ–≤–ø–∞–¥–∞—é—Ç

4. **Test `test_classification_workflow(database_service)`:**
   - –°–æ–∑–¥–∞—ë—Ç email
   - –û–±–Ω–æ–≤–ª—è–µ—Ç classification: `database_service.update_classification()`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ:
     - `email.intent` –æ–±–Ω–æ–≤–∏–ª—Å—è
     - `email.classified_at` –Ω–µ None
     - –°–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å –≤ `classification_history`

5. **Test `test_contact_auto_update(database_service)`:**
   - –°–æ–∑–¥–∞—ë—Ç 2 emails –æ—Ç –æ–¥–Ω–æ–≥–æ from_address
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ Contact record:
     - `emails_received_count == 2`
     - `last_email_at` –æ–±–Ω–æ–≤–∏–ª—Å—è

**–§–ê–ô–õ 3: `tests/conftest.py`** (Shared fixtures)

```python
import pytest
import asyncio
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession

@pytest.fixture(scope="session")
def event_loop():
    """Create event loop for async tests."""
    loop = asyncio.get_event_loop_policy().new_event_loop()
    yield loop
    loop.close()

@pytest.fixture
async def test_db_engine():
    """Create test database engine."""
    engine = create_async_engine(
        "sqlite+aiosqlite:///:memory:",
        echo=False
    )
    
    # Create tables
    async with engine.begin() as conn:
        # TODO: Run CREATE TABLE statements
        pass
    
    yield engine
    await engine.dispose()

@pytest.fixture
async def test_db_session(test_db_engine):
    """Create test database session."""
    async_session = async_sessionmaker(test_db_engine, expire_on_commit=False)
    async with async_session() as session:
        yield session
```

**Imports –¥–ª—è test_email_parser.py:**
```python
import pytest
from unittest.mock import Mock, patch
from app.services.email_parser import EmailParserService
```

**Imports –¥–ª—è test_integration.py:**
```python
import pytest
from uuid import uuid4
from datetime import datetime
from app.services.database import DatabaseService
from app.models.email_models import EmailCreate, ClassificationResult, EmailIntent, EmailSentiment, EmailPriority
```

**–í–ê–ñ–ù–û:**
- –í—Å–µ —Ç–µ—Å—Ç—ã async: `async def test_...()`
- –ò—Å–ø–æ–ª—å–∑—É–π `@pytest.mark.asyncio` decorator
- Mock S3 client –≤ unit tests
- –ò—Å–ø–æ–ª—å–∑—É–π pytest fixtures
- Assert statements –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä:** ~200 —Å—Ç—Ä–æ–∫ Python (100 per file)

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 3 —Ñ–∞–π–ª–∞:
1. tests/test_email_parser.py (6 —Ç–µ—Å—Ç–æ–≤)
2. tests/test_integration.py (5 —Ç–µ—Å—Ç–æ–≤)
3. tests/conftest.py (shared fixtures)
```

---

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
- ‚úÖ tests/test_email_parser.py —Å–æ–¥–µ—Ä–∂–∏—Ç 6 unit tests
- ‚úÖ tests/test_integration.py —Å–æ–¥–µ—Ä–∂–∏—Ç 5 integration tests
- ‚úÖ tests/conftest.py —Å–æ–¥–µ—Ä–∂–∏—Ç shared fixtures
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã async —Å `@pytest.mark.asyncio`

---

# –ö–û–ú–ê–ù–î–ê 7: –°–æ–∑–¥–∞—Ç—å Docker Files

## üìÑ –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –≤ Copilot Chat:

```
–°–æ–∑–¥–∞–π 2 —Ñ–∞–π–ª–∞ –¥–ª—è Docker deployment Email Intelligence Platform:

**–§–ê–ô–õ 1: `Dockerfile`** (Multi-stage build –¥–ª—è production)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

1. **Stage 1: Builder**
   - Base image: `python:3.11-slim`
   - Install build dependencies: `gcc postgresql-dev`
   - Install Python dependencies: `COPY requirements.txt` ‚Üí `pip install --no-cache-dir -r requirements.txt`

2. **Stage 2: Runtime**
   - Base image: `python:3.11-slim`
   - Copy installed packages from builder: `COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages`
   - Copy app code: `COPY app/ /app/app/`
   - Working directory: `/app`
   - Expose port: `8000`
   - Health check: `HEALTHCHECK --interval=30s --timeout=3s CMD curl -f http://localhost:8000/health || exit 1`
   - CMD: `["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]`

**–§–ê–ô–õ 2: `docker-compose.yml`** (6 —Å–µ—Ä–≤–∏—Å–æ–≤)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

1. **Service: postgres**
   - Image: `postgres:15`
   - Environment:
     - `POSTGRES_DB=email_db`
     - `POSTGRES_USER=email_user`
     - `POSTGRES_PASSWORD=email_pass`
   - Ports: `5432:5432`
   - Volumes:
     - `postgres_data:/var/lib/postgresql/data`
     - `./migrations:/docker-entrypoint-initdb.d`
   - Healthcheck: `pg_isready -U email_user`

2. **Service: redis** (–¥–ª—è caching)
   - Image: `redis:7-alpine`
   - Ports: `6379:6379`
   - Command: `redis-server --appendonly yes`
   - Volumes: `redis_data:/data`

3. **Service: kafka** (–¥–ª—è message queue)
   - Image: `bitnami/kafka:latest`
   - Ports: `9092:9092`
   - Environment:
     - `KAFKA_BROKER_ID=1`
     - `KAFKA_LISTENERS=PLAINTEXT://:9092`
     - `KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092`
     - `KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181`
   - Depends on: `zookeeper`

4. **Service: zookeeper**
   - Image: `bitnami/zookeeper:latest`
   - Ports: `2181:2181`
   - Environment: `ALLOW_ANONYMOUS_LOGIN=yes`

5. **Service: ollama** (LLM –¥–ª—è classification)
   - Image: `ollama/ollama:latest`
   - Ports: `11434:11434`
   - Volumes: `ollama_data:/root/.ollama`
   - Command: `serve`

6. **Service: email-service** (–Ω–∞—à FastAPI app)
   - Build: `context: .` `dockerfile: Dockerfile`
   - Ports: `8000:8000`
   - Environment:
     - `DATABASE_URL=postgresql+asyncpg://email_user:email_pass@postgres:5432/email_db`
     - `S3_BUCKET=email-attachments`
     - `OLLAMA_URL=http://ollama:11434`
     - `LOG_LEVEL=INFO`
   - Depends on: `postgres`, `redis`, `kafka`, `ollama`
   - Healthcheck: `curl -f http://localhost:8000/health`
   - Restart: `unless-stopped`

**Volumes:**
```yaml
volumes:
  postgres_data:
  redis_data:
  ollama_data:
```

**Networks:**
```yaml
networks:
  default:
    name: email-platform
    driver: bridge
```

**–í–ê–ñ–ù–û:**
- Dockerfile –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å multi-stage –¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ image
- docker-compose.yml –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å healthchecks –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π environment variables –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- Volumes –¥–ª—è persistent data (postgres, redis, ollama)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä:** ~40 —Å—Ç—Ä–æ–∫ Dockerfile + ~150 —Å—Ç—Ä–æ–∫ docker-compose.yml

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 2 —Ñ–∞–π–ª–∞:
1. Dockerfile (multi-stage build)
2. docker-compose.yml (6 —Å–µ—Ä–≤–∏—Å–æ–≤ + volumes + networks)
```

---

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
- ‚úÖ Dockerfile –∏—Å–ø–æ–ª—å–∑—É–µ—Ç multi-stage build
- ‚úÖ docker-compose.yml —Å–æ–¥–µ—Ä–∂–∏—Ç 6 —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ Healthchecks –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ Volumes –¥–ª—è persistent data

---

# –ö–û–ú–ê–ù–î–ê 8: –°–æ–∑–¥–∞—Ç—å Requirements + Documentation

## üìÑ –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –≤ Copilot Chat:

```
–°–æ–∑–¥–∞–π 2 —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–∞ –¥–ª—è Email Intelligence Platform:

**–§–ê–ô–õ 1: `requirements.txt`**

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

–î–æ–±–∞–≤—å —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å –≤–µ—Ä—Å–∏—è–º–∏:

**Web Framework:**
- `fastapi==0.109.0`
- `uvicorn[standard]==0.27.0`
- `pydantic==2.6.0`
- `pydantic-settings==2.1.0`

**Database:**
- `sqlalchemy==2.0.25`
- `asyncpg==0.29.0`
- `alembic==1.13.1`
- `psycopg2-binary==2.9.9`

**AWS / Storage:**
- `boto3==1.34.0`
- `botocore==1.34.0`

**Email Parsing:**
- (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É `email`)

**Testing:**
- `pytest==8.0.0`
- `pytest-asyncio==0.23.3`
- `pytest-cov==4.1.0`
- `httpx==0.26.0`

**Monitoring:**
- `prometheus-client==0.19.0`
- `prometheus-fastapi-instrumentator==6.1.0`

**Logging:**
- `python-json-logger==2.0.7`

**Other:**
- `python-multipart==0.0.6`
- `python-dotenv==1.0.0`
- `redis==5.0.1`
- `aiokafka==0.10.0`
- `httpx==0.26.0` (–¥–ª—è LLM requests)

**–§–ê–ô–õ 2: `SETUP.md`** (–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—é)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

–°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏:

1. **Prerequisites:**
   - Docker Desktop 4.20+
   - Python 3.11+
   - Git
   - AWS CLI (–¥–ª—è S3)
   - kubectl (–¥–ª—è production)

2. **Local Development Setup:**
   ```bash
   # Clone repository
   git clone https://github.com/your-org/email-intelligence-platform
   cd email-intelligence-platform
   
   # Create virtual environment
   python -m venv venv
   source venv/bin/activate  # Windows: venv\Scripts\activate
   
   # Install dependencies
   pip install -r requirements.txt
   
   # Copy .env.example to .env
   cp .env.example .env
   
   # Edit .env with your settings
   nano .env
   ```

3. **Database Setup:**
   ```bash
   # Start PostgreSQL via Docker
   docker-compose up -d postgres
   
   # Wait for postgres to be ready
   docker-compose exec postgres pg_isready -U email_user
   
   # Apply migrations
   docker-compose exec postgres psql -U email_user -d email_db -f /docker-entrypoint-initdb.d/001_init_schema.sql
   
   # Verify tables created
   docker-compose exec postgres psql -U email_user -d email_db -c "\dt"
   ```

4. **Run Application:**
   ```bash
   # Start all services
   docker-compose up -d
   
   # Check all containers are healthy
   docker-compose ps
   
   # View logs
   docker-compose logs -f email-service
   
   # Test API
   curl http://localhost:8000/health
   ```

5. **Run Tests:**
   ```bash
   # Install dev dependencies
   pip install -r requirements-dev.txt
   
   # Run unit tests
   pytest tests/test_email_parser.py -v
   
   # Run integration tests
   pytest tests/test_integration.py -v
   
   # Run all tests with coverage
   pytest -v --cov=app --cov-report=html
   
   # Open coverage report
   open htmlcov/index.html
   ```

6. **Production Deployment (Kubernetes):**
   ```bash
   # Create namespace
   kubectl create namespace email-platform
   
   # Apply ConfigMaps
   kubectl apply -f k8s/configmap.yml
   
   # Apply Secrets (edit first!)
   kubectl apply -f k8s/secrets.yml
   
   # Deploy PostgreSQL
   kubectl apply -f k8s/postgres-deployment.yml
   
   # Deploy email-service
   kubectl apply -f k8s/email-service-deployment.yml
   
   # Check pods
   kubectl get pods -n email-platform
   
   # Check logs
   kubectl logs -f deployment/email-service -n email-platform
   ```

7. **Monitoring:**
   ```bash
   # Access Grafana
   kubectl port-forward svc/grafana 3000:3000 -n email-platform
   # Open http://localhost:3000 (admin/admin)
   
   # Access Prometheus
   kubectl port-forward svc/prometheus 9090:9090 -n email-platform
   # Open http://localhost:9090
   ```

8. **Troubleshooting:**
   - Problem: Database connection failed
     - Solution: Check DATABASE_URL in .env
   - Problem: S3 upload fails
     - Solution: Check AWS credentials and bucket permissions
   - Problem: LLM classification slow
     - Solution: Increase Ollama resources in docker-compose.yml

9. **Environment Variables:**
   ```bash
   # Required
   DATABASE_URL=postgresql+asyncpg://email_user:email_pass@localhost:5432/email_db
   S3_BUCKET=email-attachments
   
   # Optional
   OLLAMA_URL=http://localhost:11434
   LOG_LEVEL=INFO
   REDIS_URL=redis://localhost:6379
   KAFKA_BROKERS=localhost:9092
   AWS_ACCESS_KEY_ID=your_key
   AWS_SECRET_ACCESS_KEY=your_secret
   AWS_REGION=us-east-1
   ```

10. **Next Steps:**
    - Configure LLM model: `docker exec -it ollama ollama pull llama3.1`
    - Create S3 bucket: `aws s3 mb s3://email-attachments`
    - Setup monitoring alerts: See `docs/issues/TZ-PHASE1-002-ALERTMANAGER.md`
    - Run E2E tests: `pytest tests/test_e2e.py`

**–í–ê–ñ–ù–û:**
- –í—Å–µ bash –∫–æ–º–∞–Ω–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- –í–∫–ª—é—á–∏ troubleshooting —Å–µ–∫—Ü–∏—é
- –î–æ–±–∞–≤—å –ø—Ä–∏–º–µ—Ä—ã .env —Ñ–∞–π–ª–∞
- –£–∫–∞–∂–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ—Å—É—Ä—Å–∞–º

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä:** ~45 —Å—Ç—Ä–æ–∫ requirements.txt + ~100 —Å—Ç—Ä–æ–∫ SETUP.md

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 2 —Ñ–∞–π–ª–∞:
1. requirements.txt (–≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å –≤–µ—Ä—Å–∏—è–º–∏)
2. SETUP.md (–ø–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
```

---

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
- ‚úÖ requirements.txt —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å –≤–µ—Ä—Å–∏—è–º–∏
- ‚úÖ SETUP.md —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è:
  - Local development
  - Database setup
  - Running tests
  - Production deployment
  - Troubleshooting

---

## üéâ –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú!

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö 8 –∫–æ–º–∞–Ω–¥ —É –≤–∞—Å –±—É–¥–µ—Ç:

```
email-service/
‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îî‚îÄ‚îÄ 001_init_schema.sql       # ‚úÖ –ö–û–ú–ê–ù–î–ê 1 (350 lines)
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ email_models.py       # ‚úÖ –ö–û–ú–ê–ù–î–ê 2 (200 lines)
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email_parser.py       # ‚úÖ –ö–û–ú–ê–ù–î–ê 3 (250 lines)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database.py           # ‚úÖ –ö–û–ú–ê–ù–î–ê 4 (200 lines)
‚îÇ   ‚îî‚îÄ‚îÄ main.py                   # ‚úÖ –ö–û–ú–ê–ù–î–ê 5 (200 lines)
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py               # ‚úÖ –ö–û–ú–ê–ù–î–ê 6 (50 lines)
‚îÇ   ‚îú‚îÄ‚îÄ test_email_parser.py      # ‚úÖ –ö–û–ú–ê–ù–î–ê 6 (100 lines)
‚îÇ   ‚îî‚îÄ‚îÄ test_integration.py       # ‚úÖ –ö–û–ú–ê–ù–î–ê 6 (100 lines)
‚îú‚îÄ‚îÄ Dockerfile                     # ‚úÖ –ö–û–ú–ê–ù–î–ê 7 (40 lines)
‚îú‚îÄ‚îÄ docker-compose.yml             # ‚úÖ –ö–û–ú–ê–ù–î–ê 7 (150 lines)
‚îú‚îÄ‚îÄ requirements.txt               # ‚úÖ –ö–û–ú–ê–ù–î–ê 8 (45 lines)
‚îî‚îÄ‚îÄ SETUP.md                       # ‚úÖ –ö–û–ú–ê–ù–î–ê 8 (100 lines)
```

**–ò–¢–û–ì–û: 1,735 —Å—Ç—Ä–æ–∫ production-ready –∫–æ–¥–∞ –∑–∞ 2-3 —á–∞—Å–∞!**

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã:**
   ```bash
   docker-compose up -d
   docker-compose ps  # –í—Å–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å healthy
   ```

2. **–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**
   ```bash
   docker-compose exec postgres psql -U email_user -d email_db -f /docker-entrypoint-initdb.d/001_init_schema.sql
   ```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã:**
   ```bash
   pytest -v --cov=app --cov-report=term-missing
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ API:**
   ```bash
   curl http://localhost:8000/health
   curl http://localhost:8000/metrics
   ```

5. **–ò–∑—É—á–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:**
   - –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ `SETUP.md` –¥–ª—è production deployment
   - –ò–∑—É—á–∏—Ç–µ `docs/issues/README_PHASE1_TZ.md` –¥–ª—è Phase 1 roadmap

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 15 –¥–µ–∫–∞–±—Ä—è 2025 –≥.  
**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–ê–≤—Ç–æ—Ä:** Email Intelligence Platform Team  
**–õ–∏—Ü–µ–Ω–∑–∏—è:** MIT
