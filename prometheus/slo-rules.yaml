# üìä PROMETHEUS SLO MONITORING RULES
# Email Intelligence Platform - Production SLO Tracking

groups:
  - name: slo_availability
    interval: 30s
    rules:
      # SLI: Availability (—É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã / –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã)
      - record: slo:email_service:availability:ratio_rate5m
        expr: |
          sum(rate(email_service_requests_total{status="success"}[5m]))
          /
          sum(rate(email_service_requests_total[5m]))
      
      # SLI: Latency P95 (95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å)
      - record: slo:email_service:latency:p95
        expr: |
          histogram_quantile(0.95,
            sum(rate(email_service_duration_ms_bucket[5m])) by (le)
          )
      
      # SLI: Latency P99 (99-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å)
      - record: slo:email_service:latency:p99
        expr: |
          histogram_quantile(0.99,
            sum(rate(email_service_duration_ms_bucket[5m])) by (le)
          )
      
      # Error budget (30 –¥–Ω–µ–π)
      - record: slo:email_service:error_budget_remaining
        expr: |
          1 - (
            (1 - slo:email_service:availability:ratio_rate5m)
            /
            (1 - 0.999)
          )

  - name: slo_alerts_multi_burn_rate
    interval: 30s
    rules:
      # ========================================
      # P0: CRITICAL - Page on-call (5 min response)
      # ========================================
      
      # Fast Burn (2% error budget/hour) - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è
      - alert: SLO_ErrorBudget_FastBurn_Critical
        expr: |
          (
            slo:email_service:availability:ratio_rate5m < 0.999
            and
            slo:email_service:availability:ratio_rate5m < 0.98
          )
          or
          (
            slo:email_service:latency:p95 > 800
            and
            slo:email_service:latency:p95 > 2000
          )
        for: 2m
        labels:
          severity: critical
          priority: P0
          escalation: pagerduty
        annotations:
          summary: "üö® P0: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è SLO"
          description: |
            –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø –¢–†–ï–ë–£–Æ–¢–°–Ø!
            
            Availability: {{ $value | humanizePercentage }}
            –¶–µ–ª—å: 99.9%
            
            –ò–ª–∏ Latency P95: {{ $value }}ms
            –¶–µ–ª—å: <800ms
            
            Error budget —Å–≥–æ—Ä–∞–µ—Ç —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é 2%/—á–∞—Å!
            
            Runbook: docs/P0_RUNBOOK_RU.md
          dashboard: "https://grafana.97v.ru/d/email-platform-slo"
          
      # Availability —É–ø–∞–ª–∞ –Ω–∏–∂–µ 99%
      - alert: SLO_Availability_Below99_P0
        expr: |
          slo:email_service:availability:ratio_rate5m < 0.99
        for: 1m
        labels:
          severity: critical
          priority: P0
          escalation: pagerduty
        annotations:
          summary: "üö® P0: Availability —É–ø–∞–ª–∞ –Ω–∏–∂–µ 99%"
          description: |
            –¢–µ–∫—É—â–∞—è availability: {{ $value | humanizePercentage }}
            SLO —Ü–µ–ª—å: 99.9%
            
            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
            1. kubectl get pods -n production
            2. kubectl logs -f deployment/email-service
            3. Kafka consumer lag
            4. PostgreSQL connections
            
      # Latency P99 –ø—Ä–µ–≤—ã—Å–∏–ª–∞ 5 —Å–µ–∫—É–Ω–¥
      - alert: SLO_Latency_P99_Critical
        expr: |
          slo:email_service:latency:p99 > 5000
        for: 2m
        labels:
          severity: critical
          priority: P0
          escalation: pagerduty
        annotations:
          summary: "üö® P0: Latency P99 >5s (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è)"
          description: |
            P99 Latency: {{ $value }}ms
            SLO —Ü–µ–ª—å: <2000ms
            
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏—Å–ø—ã—Ç—ã–≤–∞—é—Ç —Ç–∞–π–º-–∞—É—Ç—ã!
            
      # Error rate >5%
      - alert: SLO_ErrorRate_Above5Percent
        expr: |
          (
            sum(rate(email_service_errors_total[5m]))
            /
            sum(rate(email_service_requests_total[5m]))
          ) > 0.05
        for: 1m
        labels:
          severity: critical
          priority: P0
          escalation: pagerduty
        annotations:
          summary: "üö® P0: Error rate >5%"
          description: |
            Error rate: {{ $value | humanizePercentage }}
            –î–æ–ø—É—Å—Ç–∏–º–æ: <0.1%
            
            –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
            - –ù–µ–¥–∞–≤–Ω–∏–π deploy
            - –ü—Ä–æ–±–ª–µ–º—ã —Å –ë–î
            - Kafka –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            
      # ========================================
      # P1: HIGH - Slack notification (30 min response)
      # ========================================
      
      # Medium Burn (5% error budget/6h) - –ë—ã—Å—Ç—Ä–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è
      - alert: SLO_ErrorBudget_MediumBurn_High
        expr: |
          slo:email_service:availability:ratio_rate5m < 0.999
          and
          slo:email_service:availability:ratio_rate5m >= 0.98
        for: 10m
        labels:
          severity: high
          priority: P1
          escalation: slack
        annotations:
          summary: "‚ö†Ô∏è P1: –£–º–µ—Ä–µ–Ω–Ω–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è SLO"
          description: |
            Availability: {{ $value | humanizePercentage }}
            –¶–µ–ª—å: 99.9%
            
            Error budget —Å–≥–æ—Ä–∞–µ—Ç —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é 5%/6—á
            –†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç
            
      # Latency P95 –ø—Ä–µ–≤—ã—Å–∏–ª–∞ —Ü–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      - alert: SLO_Latency_P95_High
        expr: |
          slo:email_service:latency:p95 > 800
          and
          slo:email_service:latency:p95 <= 2000
        for: 5m
        labels:
          severity: high
          priority: P1
          escalation: slack
        annotations:
          summary: "‚ö†Ô∏è P1: Latency P95 –ø—Ä–µ–≤—ã—Å–∏–ª–∞ SLO"
          description: |
            P95 Latency: {{ $value }}ms
            SLO —Ü–µ–ª—å: <800ms
            
            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
            - Email classifier performance
            - PostgreSQL slow queries
            - LLM inference queue
            
      # Kafka consumer lag >10k
      - alert: SLO_KafkaLag_High
        expr: |
          kafka_consumer_lag{topic="email.received"} > 10000
        for: 10m
        labels:
          severity: high
          priority: P1
          escalation: slack
        annotations:
          summary: "‚ö†Ô∏è P1: Kafka consumer lag >10k"
          description: |
            Lag: {{ $value }}
            Topic: email.received
            
            Email –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–º–µ–¥–ª–µ–Ω–∞!
            –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: Scale up email-consumer replicas
            
      # PostgreSQL connections >80%
      - alert: SLO_PostgreSQL_Connections_High
        expr: |
          pg_stat_activity_count > 80
        for: 5m
        labels:
          severity: high
          priority: P1
          escalation: slack
        annotations:
          summary: "‚ö†Ô∏è P1: PostgreSQL connections >80%"
          description: |
            –¢–µ–∫—É—â–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {{ $value }}
            Max connections: 100
            
            –í–æ–∑–º–æ–∂–Ω–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∞ connections!
            
      # ========================================
      # P2: MEDIUM - Email notification (next business day)
      # ========================================
      
      # Slow Burn (10% error budget/3d) - –ú–µ–¥–ª–µ–Ω–Ω–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è
      - alert: SLO_ErrorBudget_SlowBurn_Medium
        expr: |
          slo:email_service:availability:ratio_rate5m < 0.999
        for: 1h
        labels:
          severity: medium
          priority: P2
          escalation: email
        annotations:
          summary: "‚ÑπÔ∏è P2: –ú–µ–¥–ª–µ–Ω–Ω–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è SLO"
          description: |
            Availability: {{ $value | humanizePercentage }}
            –¶–µ–ª—å: 99.9%
            
            Error budget —Å–≥–æ—Ä–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ (10%/3–¥)
            –†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤ —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã
            
      # Disk space warning
      - alert: SLO_DiskSpace_Warning
        expr: |
          (
            node_filesystem_avail_bytes{mountpoint="/"}
            /
            node_filesystem_size_bytes{mountpoint="/"}
          ) < 0.2
        for: 1h
        labels:
          severity: medium
          priority: P2
          escalation: email
        annotations:
          summary: "‚ÑπÔ∏è P2: Disk space <20%"
          description: |
            –î–æ—Å—Ç—É–ø–Ω–æ: {{ $value | humanizePercentage }}
            
            –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –æ—á–∏—Å—Ç–∫—É –ª–æ–≥–æ–≤/–∫—ç—à–∞
            
      # Memory usage warning
      - alert: SLO_Memory_Usage_High
        expr: |
          (
            1 - (
              node_memory_MemAvailable_bytes
              /
              node_memory_MemTotal_bytes
            )
          ) > 0.85
        for: 15m
        labels:
          severity: medium
          priority: P2
          escalation: email
        annotations:
          summary: "‚ÑπÔ∏è P2: Memory usage >85%"
          description: |
            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: {{ $value | humanizePercentage }}
            
            –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç memory leak

  - name: slo_component_health
    interval: 1m
    rules:
      # Email service pod down
      - alert: Component_EmailService_Down
        expr: |
          up{job="email-service"} == 0
        for: 30s
        labels:
          severity: critical
          priority: P0
          component: email-service
        annotations:
          summary: "üö® Email Service pod –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          description: |
            Email service –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç!
            
            kubectl get pods -n production
            kubectl describe pod <pod-name> -n production
            
      # PostgreSQL down
      - alert: Component_PostgreSQL_Down
        expr: |
          up{job="postgresql"} == 0
        for: 30s
        labels:
          severity: critical
          priority: P0
          component: database
        annotations:
          summary: "üö® PostgreSQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          description: |
            –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç!
            
            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
            kubectl get pods -n production | grep postgres
            kubectl logs -f postgres-0 -n production
            
      # Kafka broker down
      - alert: Component_Kafka_Down
        expr: |
          up{job="kafka"} == 0
        for: 1m
        labels:
          severity: critical
          priority: P0
          component: kafka
        annotations:
          summary: "üö® Kafka broker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          description: |
            Kafka –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç!
            
            Email pipeline –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!
            
      # Redis down
      - alert: Component_Redis_Down
        expr: |
          up{job="redis"} == 0
        for: 1m
        labels:
          severity: high
          priority: P1
          component: redis
        annotations:
          summary: "‚ö†Ô∏è Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          description: |
            Redis –∫—ç—à –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
            
            Degraded performance –æ–∂–∏–¥–∞–µ—Ç—Å—è
