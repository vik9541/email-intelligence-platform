# üö® ALERTMANAGER CONFIGURATION
# Email Intelligence Platform - Incident Response Automation

global:
  # Slack webhook –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  slack_api_url: 'https://hooks.slack.com/services/YOUR_WEBHOOK_URL'
  
  # SMTP –¥–ª—è email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  smtp_from: 'alerts@97v.ru'
  smtp_smarthost: 'smtp.97v.ru:587'
  smtp_auth_username: 'alerts@97v.ru'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
route:
  # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–ª–∞—Å—Ç–µ—Ä—É, severity, alertname
  group_by: ['cluster', 'severity', 'alertname']
  
  # –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π (–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤)
  group_wait: 10s
  
  # –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏
  group_interval: 5m
  
  # –ü–æ–≤—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  repeat_interval: 4h
  
  # –ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  receiver: 'default-email'
  
  # –ú–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
  routes:
    # ========================================
    # P0: CRITICAL - PagerDuty + Slack + Email
    # ========================================
    - match:
        priority: P0
      receiver: 'pagerduty-critical'
      group_wait: 5s
      group_interval: 1m
      repeat_interval: 5m
      continue: true
      
    - match:
        priority: P0
      receiver: 'slack-critical'
      continue: true
      
    - match:
        priority: P0
      receiver: 'incident-webhook'
      continue: false
    
    # ========================================
    # P1: HIGH - Slack + Email
    # ========================================
    - match:
        priority: P1
      receiver: 'slack-high'
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 1h
      continue: true
      
    - match:
        priority: P1
      receiver: 'email-oncall'
      continue: false
    
    # ========================================
    # P2: MEDIUM - Email —Ç–æ–ª—å–∫–æ
    # ========================================
    - match:
        priority: P2
      receiver: 'email-team'
      group_wait: 5m
      group_interval: 1h
      repeat_interval: 24h

# –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
receivers:
  # Default receiver
  - name: 'default-email'
    email_configs:
      - to: 'devops@97v.ru'
        headers:
          Subject: '[Monitoring] {{ .GroupLabels.alertname }}'
        html: |
          <h2>{{ .GroupLabels.alertname }}</h2>
          <p><strong>Severity:</strong> {{ .CommonLabels.severity }}</p>
          <p><strong>Description:</strong> {{ .CommonAnnotations.description }}</p>
  
  # ========================================
  # P0 Receivers
  # ========================================
  
  # PagerDuty –¥–ª—è P0 (–≤—ã–∑–æ–≤ –¥–µ–∂—É—Ä–Ω–æ–≥–æ)
  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        severity: 'critical'
        description: '{{ .CommonAnnotations.summary }}'
        details:
          firing: '{{ .Alerts.Firing | len }}'
          resolved: '{{ .Alerts.Resolved | len }}'
          description: '{{ .CommonAnnotations.description }}'
          dashboard: '{{ .CommonAnnotations.dashboard }}'
  
  # Slack –∫–∞–Ω–∞–ª #incidents –¥–ª—è P0
  - name: 'slack-critical'
    slack_configs:
      - channel: '#incidents'
        color: 'danger'
        title: 'üö® P0 CRITICAL: {{ .GroupLabels.alertname }}'
        text: |
          *Summary:* {{ .CommonAnnotations.summary }}
          
          *Severity:* {{ .CommonLabels.severity }}
          *Priority:* {{ .CommonLabels.priority }}
          
          *Description:*
          {{ .CommonAnnotations.description }}
          
          *Dashboard:* {{ .CommonAnnotations.dashboard }}
          
          *Action Required:* –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (5 –º–∏–Ω)
        short_fields: true
        actions:
          - type: button
            text: 'Acknowledge'
            url: '{{ .CommonAnnotations.dashboard }}'
          - type: button
            text: 'Runbook'
            url: 'https://github.com/vik9541/email-intelligence-platform/blob/main/docs/P0_RUNBOOK_RU.md'
  
  # Webhook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞
  - name: 'incident-webhook'
    webhook_configs:
      - url: 'http://incident-api.production.svc.cluster.local:8080/webhook/alert'
        send_resolved: true
        http_config:
          bearer_token: '${INCIDENT_API_TOKEN}'
  
  # ========================================
  # P1 Receivers
  # ========================================
  
  # Slack –∫–∞–Ω–∞–ª #alerts –¥–ª—è P1
  - name: 'slack-high'
    slack_configs:
      - channel: '#alerts'
        color: 'warning'
        title: '‚ö†Ô∏è P1 HIGH: {{ .GroupLabels.alertname }}'
        text: |
          *Summary:* {{ .CommonAnnotations.summary }}
          
          *Description:*
          {{ .CommonAnnotations.description }}
          
          *Action Required:* –†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç
        short_fields: true
  
  # Email –¥–ª—è –¥–µ–∂—É—Ä–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã (P1)
  - name: 'email-oncall'
    email_configs:
      - to: 'oncall@97v.ru'
        headers:
          Subject: '‚ö†Ô∏è [P1 HIGH] {{ .GroupLabels.alertname }}'
          Priority: 'high'
        html: |
          <h2 style="color: orange;">‚ö†Ô∏è P1 HIGH Priority Alert</h2>
          
          <h3>{{ .CommonAnnotations.summary }}</h3>
          
          <p><strong>Severity:</strong> {{ .CommonLabels.severity }}</p>
          <p><strong>Priority:</strong> {{ .CommonLabels.priority }}</p>
          
          <h4>Description:</h4>
          <pre>{{ .CommonAnnotations.description }}</pre>
          
          <p><strong>Dashboard:</strong> <a href="{{ .CommonAnnotations.dashboard }}">{{ .CommonAnnotations.dashboard }}</a></p>
          
          <p><em>Action Required: –†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç</em></p>
  
  # ========================================
  # P2 Receivers
  # ========================================
  
  # Email –¥–ª—è –≤—Å–µ–π –∫–æ–º–∞–Ω–¥—ã (P2)
  - name: 'email-team'
    email_configs:
      - to: 'devops@97v.ru, sre@97v.ru'
        headers:
          Subject: '‚ÑπÔ∏è [P2 MEDIUM] {{ .GroupLabels.alertname }}'
          Priority: 'normal'
        html: |
          <h2 style="color: blue;">‚ÑπÔ∏è P2 MEDIUM Priority Alert</h2>
          
          <h3>{{ .CommonAnnotations.summary }}</h3>
          
          <p><strong>Description:</strong></p>
          <pre>{{ .CommonAnnotations.description }}</pre>
          
          <p><em>Action Required: –†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤ —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã</em></p>

# –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤ (silence)
inhibit_rules:
  # –ï—Å–ª–∏ email-service down, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∞–ª–µ—Ä—Ç—ã –æ latency
  - source_match:
      alertname: 'Component_EmailService_Down'
    target_match_re:
      alertname: 'SLO_Latency_.*'
    equal: ['cluster', 'namespace']
  
  # –ï—Å–ª–∏ PostgreSQL down, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∞–ª–µ—Ä—Ç—ã –æ connections
  - source_match:
      alertname: 'Component_PostgreSQL_Down'
    target_match:
      alertname: 'SLO_PostgreSQL_Connections_High'
    equal: ['cluster']
  
  # –ï—Å–ª–∏ Kafka down, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∞–ª–µ—Ä—Ç—ã –æ lag
  - source_match:
      alertname: 'Component_Kafka_Down'
    target_match:
      alertname: 'SLO_KafkaLag_High'
    equal: ['cluster']

# –®–∞–±–ª–æ–Ω—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
templates:
  - '/etc/alertmanager/templates/*.tmpl'
